<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style2.css') }}">
    <title>Flask App</title>
</head>

<body>
    <div class="chat-container">
        <!-- æ–°å¢çš„æ¨™é¡Œå€å¡Š -->
        <div class="chat-header">Library AI Chatbot</div>

        <!-- Loading gif -->
        <div id="loading_img"><img src="{{ url_for('static', filename='images/loading.gif') }}" alt="Loading..."
                width="30px"></div>

        <!-- å›æ‡‰è¨Šæ¯å€åŸŸï¼Œè¨­ç½®æœ€å¤§é«˜åº¦ -->
        <div id="responseMessage" style="max-height: 80%; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;line-height:25px;">
            <!-- <div class="introduction">è«‹å‹¿æå•éåœ–æ›¸é¤¨å•é¡Œ.<br>å¦‚è¦æ‰¾æ›¸è«‹ç°¡çŸ­è¼¸å…¥ <span style="color: #d6560c;;">æˆ‘è¦æ‰¾xxxçš„æ›¸</span> è®“Aiå°å¹«æ‰‹å¹«æ‚¨æ‰¾çœ‹çœ‹.<p>
                Please do not ask non-library-related questions.<br>If you're looking for a book,  just type <span style="color: #d6560c;;">Please find books on xxx</span> so our AI assistant can help you find it.</div> -->
        </div>

        <!-- æäº¤è¡¨å–® -->
        <div class="login">
            <form id="myForm" class="form">
                <input type="text" id="question" name="question" placeholder="text..." required>
                <button type="submit">âœˆ</button>
            </form>
        </div>
    </div>
   
   
    <script>
        let isPrinting = false;  // ç”¨ä¾†æ¨™èªŒæ˜¯å¦æ­£åœ¨åˆ—å°å›ç­”
        let currentInterval = null;  // å­˜å„²ç•¶å‰çš„setInterval IDï¼Œä»¥ä¾¿å¯ä»¥ä¸­æ­¢
    
        document.getElementById('myForm').addEventListener('submit', async function (event) {
            event.preventDefault();
    
            // æ¸…ç©ºä¹‹å‰çš„å›ç­”å’ŒæŒ‰éˆ•
            const messageDiv = document.getElementById('responseMessage');
            messageDiv.innerHTML = messageDiv.innerHTML.split('<div class="introduction">')[0]; // æ¸…é™¤ä»‹ç´¹æ–‡æœ¬éƒ¨åˆ†
            messageDiv.scrollTop = messageDiv.scrollHeight;  // æ»¾å‹•åˆ°åº•éƒ¨
    
            // æå–å•é¡Œä¸¦é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            const question = document.getElementById('question').value;
            document.getElementById('question').value = ''; // æ¸…ç©ºå•é¡Œè¼¸å…¥æ¡†
    
            const userMessage = `
                <div class="message user-message-wrapper">
                    <div class="user-message">
                        <span>${question}</span>
                    </div>
                </div>
            `;
            messageDiv.innerHTML += userMessage;
            messageDiv.scrollTop = messageDiv.scrollHeight;
    
            document.getElementById('loading_img').style.display = 'block';
    
            // ç™¼é€å•é¡Œçµ¦ä¼ºæœå™¨ä¸¦ç­‰å¾…å›æ‡‰
            const response = await fetch('/lib_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "question": question })
            });
    
            const result = await response.json();
    
            if (response.ok) {
                const aiMessageWrapper = document.createElement('div');
                aiMessageWrapper.classList.add('message', 'ai-message');
                const aiMessageDiv = document.createElement('div');
                aiMessageWrapper.appendChild(aiMessageDiv);
                messageDiv.appendChild(aiMessageWrapper);
    
                let answer0 = result.answer;
                const answer = decodeURIComponent(answer0); // è§£ç¢¼å¾pythonå‚³éä¾†çš„ä¸­æ–‡å­—
    
                let currentIndex = 0;
                isPrinting = true;  // æ¨™è¨˜æ­£åœ¨åˆ—å°
    
                // å¦‚æœæœ‰æ­£åœ¨åˆ—å°çš„å›ç­”ï¼Œåœæ­¢ç›®å‰çš„setInterval
                if (currentInterval !== null) {
                    clearInterval(currentInterval);
                }
    
                // é–‹å§‹æ–°çš„ä¸€å€‹å›ç­”åˆ—å°
                currentInterval = setInterval(() => {
                   // å¦‚æœç¢°åˆ° <br>ï¼Œæ•´æ®µç›´æ¥å¡é€²å»
                    if (answer.slice(currentIndex, currentIndex + 4) === '<br>') {
                        aiMessageDiv.innerHTML += '<br>';
                        currentIndex += 4;
                    } else {
                        aiMessageDiv.innerHTML += answer[currentIndex];
                        currentIndex++;
                    }
    
                    messageDiv.scrollTop = messageDiv.scrollHeight;
    
                    if (currentIndex >= answer.length) {
                        clearInterval(currentInterval);  // å®Œæˆåˆ—å°å¾Œæ¸…é™¤interval
                        isPrinting = false;  // æ¨™è¨˜å›ç­”åˆ—å°å®Œæˆ
    
                        if (answer.includes("é¤¨è—æŸ¥è©¢")) {
                            let result = answer.split("ï¼š")[1]; 
                            if (result === undefined){
                                aiMessageDiv.innerHTML += "<br><a href='https://aleph.lib.cgu.edu.tw/F?func=find-b&find_code=WRD&adjacent=Y&local_base=FLY03' target='_blank'>å‰å»é¤¨è—æŸ¥è©¢å¹³å°</a><br>æˆ–è€…è«‹è¼¸å…¥ <span style='color:#d6560c'>æˆ‘è¦æ‰¾xxxçš„æ›¸</span>ï¼Œè®“æˆ‘å¹«æ‚¨æ‰¾çœ‹çœ‹.";                
                            } else {
                                aiMessageDiv.innerHTML += "&nbsp;<a href='https://aleph.lib.cgu.edu.tw/F?func=find-b&find_code=WRD&adjacent=Y&local_base=FLY03&request=" + result + "' target='_blank'>å‰å»é¤¨è—æŸ¥è©¢å¹³å°</a>";                       
                            }
                        }
                        if (answer.includes("visit the catalog")|| answer.includes("online catalog")|| answer.includes("find a book")|| answer.includes("any books on")|| answer.includes("a book about")|| answer.includes("a book on")|| answer.includes("a book by")|| answer.includes("search for books")) {                     
                            let result = answer.split("ï¼š")[1]; 
                            if (result === undefined){
                                aiMessageDiv.innerHTML += "<br><a href='https://aleph.lib.cgu.edu.tw/F?func=find-b&find_code=WRD&adjacent=Y&local_base=FLY03&CON_LNG=ENG' target='_blank'>Go to the catalog search website</a><br>or you can enter <span style='color:#d6560c'>find the book by xxx</span>, and let me help you search.";                
                            } else {
                                aiMessageDiv.innerHTML += "&nbsp;<a href='https://aleph.lib.cgu.edu.tw/F?func=find-b&find_code=WRD&adjacent=Y&local_base=FLY03&request=" + result + "&CON_LNG=ENG' target='_blank'>Go to the catalog search website</a>";                       
                            }
                        }
    
                        // é¡¯ç¤ºè®šå’Œå€’è®šæŒ‰éˆ•
                        const thumbsWrapper = document.createElement('div');
                        thumbsWrapper.classList.add('thumbs-wrapper');
                        
                        const thumbsUp = document.createElement('button');
                        thumbsUp.textContent = 'ğŸ‘';
                        thumbsUp.classList.add('thumbs-up');
                        thumbsUp.style.opacity = 0.2;  // é»˜èªé¡è‰²é€æ˜
    
                        thumbsUp.onclick = () => {
                            thumbsUp.style.opacity = thumbsUp.style.opacity === "0.2" ? "1" : "0.2";  // åˆ‡æ›é€æ˜åº¦
                            thumbsDown.style.opacity = 0.2;  // è®“å€’è®šæŒ‰éˆ•é€æ˜
                            updateThumbsStatus('Up', question, answer);
                        };
    
                        const thumbsDown = document.createElement('button');
                        thumbsDown.textContent = 'ğŸ‘';
                        thumbsDown.classList.add('thumbs-down');
                        thumbsDown.style.opacity = 0.2;  // é»˜èªé¡è‰²é€æ˜
    
                        thumbsDown.onclick = () => {
                            thumbsDown.style.opacity = thumbsDown.style.opacity === "0.2" ? "1" : "0.2";  // åˆ‡æ›é€æ˜åº¦
                            thumbsUp.style.opacity = 0.2;  // è®“è®šæŒ‰éˆ•é€æ˜
                            updateThumbsStatus('Down', question, answer);
                        };
    
                        thumbsWrapper.appendChild(thumbsUp);
                        thumbsWrapper.appendChild(thumbsDown);
                        messageDiv.appendChild(thumbsWrapper);
                        messageDiv.scrollTop = messageDiv.scrollHeight;
                    }
                }, 50);  // æ¯50msåˆ—å°ä¸€å€‹å­—
    
                messageDiv.scrollTop = messageDiv.scrollHeight;
            } else {
                messageDiv.innerText = `Error: ${result.error}`;
            }
    
            document.getElementById('loading_img').style.display = 'none';
        });
    
        function updateThumbsStatus(thumbs, question, answer) {
            var chat_id = JSON.parse('{{ chat_id | tojson }}');  
            const data = {
                chat_id_: chat_id,
                question_: question,
                answer_: answer,
                thumbs_: thumbs
            };
            fetch('/record_qa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => console.log('æˆåŠŸ:', data))
            .catch((error) => console.error('éŒ¯èª¤:', error));
        }
    
        window.onload = function () {
            fetch('/clear', { method: 'POST' });
        };
    </script>
    
</body>

</html> 